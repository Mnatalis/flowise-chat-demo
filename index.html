<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flowise Chat + n8n</title>
  </head>
  <body>
    <h1>Support Chat Assistant 💬</h1>

    <script type="module">
      import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js";

      const n8nWebhookUrl =
        "https://mnatalis.app.n8n.cloud/webhook/zammad-ticket";
      const triggerWords = ["support", "caregiver", "help", "take to a person"];

      // 👇 Відправити POST-запит до n8n
      const sendToN8N = async (userMessage) => {
        const payload = {
          title: "Support Request from Chatbot",
          group_id: 1,
          customer: "chatuser@example.com",
          article: {
            subject: "User Message Triggered Support",
            body: userMessage,
            type: "note",
            internal: false,
          },
        };

        await fetch(n8nWebhookUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization:
              "Token token=VTvY-c0VgWmQKV01aoBgWPc4UUAYkkl5tDGI0hl6IY24KBFNEX0uaoWltnV_ONUN",
          },
          body: JSON.stringify(payload),
        });
      };

      Chatbot.init({
        chatflowid: "5cdfad8c-7d18-4f08-91a9-ad22f9537a8c",
        apiHost: "https://app.myboxy.ai",
        theme: {
          chatWindow: {
            welcomeMessage: "Hi! How can I help you? 😊",
            backgroundColor: "#ffffff",
            botMessage: { backgroundColor: "#f0f0ff" },
            userMessage: { backgroundColor: "#d0e0ff" },
          },
        },
        // 👇 Обробка кожного повідомлення користувача
        onSend: async (userMessage) => {
          const containsTrigger = triggerWords.some((word) =>
            userMessage.toLowerCase().includes(word)
          );
          if (containsTrigger) {
            await sendToN8N(userMessage);
          }
        },
      });
    </script>
  </body>
</html>
